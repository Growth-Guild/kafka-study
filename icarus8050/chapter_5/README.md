# Chapter 5. 프로듀서의 내부 동작 원리와 구현

## 파티셔너
* 카프카의 토픽은 성능 향상을 위한 병렬 처리가 가능하도록 파티션을 최소 하나 또는 둘 이상으로 구성할 수 있다.
* 프로듀서가 토픽으로 메시지를 보낼 때, 해당 토픽의 어느 파티션으로 보낼지는 파티셔너(partitioner)가 결정한다.
* 프로듀서가 파티션을 결정하는 알고리즘은 기본적으로 메시지의 키를 해시처리하여 구한다.
  * 메시지의 키 값이 동일하면 해당 메시지들은 모두 동일한 파티션으로 전송된다.
* 카프카는 처리량을 늘리기 위해 파티션을 늘릴 수 있지만, 파티션 수가 변경될 때, 메시지의 키와 매핑된 해시 테이블도 변경된다.
  * 같은 메시지 키로 전송하더라도 파티션 수를 늘린 후에는 다른 파티션으로 전송될 수 있다.

### 라운드 로빈(round-robin) 전략
* 프로듀서의 레코드 키 값은 필수값이 아니므로, 별도의 키를 지정하지 않고 전송한다면 기본 전략인 라운드 로빈 알고리즘을 사용하여 파티션을 결정하여 전송한다.
* 파티셔너를 거친 후의 레코드들은 배치 처리를 위해 프로듀서의 버퍼 메모리 영역에서 잠시 대기한 후에 카프카로 전송된다.
* 배치 처리를 위해 메시지들이 잠시 대기하는 과정에서 라운드 로빈 전략은 효율을 떨어뜨릴 수 있다.
  * 라운드 로빈 전략은 각 파티션에 순차적으로 메시지를 할당하므로, 각 파티션별로 배치 전송을 위한 레코드 수를 채울 때까지 메시지들은 카프카로 전송되지 못한 채 프로듀서 내에 대기하기 때문이다.
  * 프로듀서의 옵션을 조정해서 특정 시간을 초과하면 즉시 카프카로 레코드들을 전송하도록 설정할 수도 있다.
  * 하지만 배치와 압축의 효과를 얻지 못한 채 레코드를 카프카로 전송될 수 있기 때문에 비효율이 발생할 수 있다.

### 스티키 파티셔닝(sticky partitioning) 전략
* 라운드 로빈 전략에서 지연시간이 불필요하게 증가하는 비효율성을 개선하기 위해 카프카 2.4버전부터 공개된 전략이다.
* 스티키 파티셔닝 전략은 하나의 파티션에 레코드 수를 먼저 채워서 카프카로 빠르게 배치 전송하는 전략이다.
* 카프카로 전송하는 메시지의 순서가 중요하지 않은 경우라면 스티키 파티셔닝 전략을 적용하는 것이 좋다.

## 프로듀서의 배치
* 프로듀서는 배치 전송 방식은 불필요한 I/O을 줄일 수 있어 효율적이며, 카프카의 요청 수를 줄여주는 효과가 있다.
* 카프카의 사용 목적에 따라 처리량을 높일지, 지연 없는 전송을 해야 할지 적절하게 선택해야 한다.
* 대량의 메시지를 처리할 대 처리량을 높여야 하는 경우라면 배치 전송이 효율적이다.
* 지연 없는 전송이 목표라면 배치 전송 관련 설정을 제거해야 한다.
* 사용자는 전송 목표를 정하고 목적에 따라 프로듀서의 옵션값을 조금씩 조정해가면서 최적의 값을 찾아가는 것이 중요하다.
* 높은 처리량을 목표로 배치 전송을 설정하는 경우에 buffer.memory 크기는 반드시 batch.size보다 커야한다.
  * 프로듀서는 전송에 실패하면 재시도를 수행하는데, 이러한 부분까지 고려하여 버퍼 메모리를 설정해야 한다.
* 배치 전송과 더블어 압축 기능을 같이 사용하면, 더욱 효율적으로 카프카로 전송할 수 있다.
  * 높은 압축률이 필요하다면 gzip, snappy 포맷을, 낮은 지연시간이 필요하다면 lz4, snappy 포맷을 선택하는 것이 좋다.
