# Chapter 8. 카프카 버전 업그레이드와 확장

## 카프카 버전 업그레이드를 위한 준비
* 카프카 버전 업그레이드를 작업하기 전에 현재 사용하고 있는 버전을 확인해야 한다.
  * kafka-topics.sh 명령어를 이용하여 확인할 수 있다.
  * 카프카 폴더의 libs 하위 디렉토리에서 kafka의 jar 파일을 확인하여 버전을 확인할 수도 있다.
```text
./kafka-topics.sh --version
```
* 메이저 버전 업그레이드는 릴리즈 노트를 확인하여 호환성 이슈는 없는지 꼼꼼하게 확인해야 한다.
* 마이너 버전 업그레이드는 비교적 용이하게 업그레이드 할 수 있다.
* 카프카의 버전 업그레이드는 크게 다운타임을 가질 수 있는 경우와 다운타임을 가질 수 없는 경우로 나뉜다.
  * 대부분의 경우는 다운타임을 가질 수 없는 경우다.

### 최신 버전의 카프카 다운로드와 설치
* kafka의 /config/server.properties 설정 파일에는 아래의 옵션이 있다.
  * inter.broker.protocol.version=2.1
  * log.message.format.version=2.1
* 위 두 설정은 2.6 버전의 카프카가 실행되어도 브로커 간의 내부 통신은 2.1 버전 기반으로 통신하며, 메시지 포맷도 2.1을 유지한다는 의미다.
* 위 설정이 없다면 이미 실행중인 이전 버전의 브로커들과 통신이 불가능하다.

### 브로커 버전 업그레이드
* 브로커 버전 업그레이드는 한 대씩 순차적으로 진행한다.
* 브로커 버전을 업그레이드하기 위해 종료하면 종료된 브로커가 갖고 있던 파티션의 리더들이 다른 브로커로 변경된다.
  * 이때 클라이언트는 일시적으로 리더를 찾지 못하는 에러가 발생하거나 타임아웃 등이 발생한다.
  * 클라이언트는 내부적으로 재시도 로직이 있으므로 이후에 새로운 리더로 변경된 브로커를 바라보게 된다.
* 새로운 버전으로 업그레이드하더라도 이전에 inter.broker.protocol.version과 log.message.format.version 옵션을 설정했기 때문에 다른 버전의 브로커들과 정상적으로 통신이 가능하다.
* 나머지 브로커도 같은 방식으로 업그레이드를 진행한다.

### 브로커 설정 변경
* 업그레이드된 브로커들은 inter.broker.protocol.version과 log.message.format.version 옵션으로 인해 이전 버전으로 통신하도록 설정된 상태다.
* 위 설정을 제거하여 브로커들이 2.6 버전으로 통신할 수 있도록 변경한다.
* 설정을 변경한 후, 브로커를 한 대씩 재시작한다.

### 업그레이드 작업 시 주의사항
* 카프카의 사용량이 적은 시간대에 업그레이드 하는 것이 좋다.
  * 카프카 사용량이 적은 시간대여야 리플리케이션일 일치시키는 내부 동작이 신속하게 이뤄질 수 있다.
* 프로듀서의 ack=1 옵션을 사용하는 경우 카프카의 롤링 재시작으로 인해 일부 메시지가 손실될 수 있다.
